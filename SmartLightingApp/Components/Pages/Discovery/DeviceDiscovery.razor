@page "/discovery"
@using SmartLightingApp.Services
@using TasmotaSharp
@inject TasmotaMdnsDiscoveryService mdnsService
@inject RelayDataService relayDataService
@inject TasmotaClient tasmotaClient
@inject NavigationManager navigation
@inject IJSRuntime JSRuntime
@inject ILocalizationService Localization
@implements IDisposable

<!-- Discovery Header -->
<div class="header">
    <div class="header-left">
        <button class="back-btn" @onclick="GoBack">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-icon">
            <i class="fas fa-search"></i>
        </div>
        <div class="header-title">
            <h1>@Localization.Current.General.ActionButtons.DeviceDiscovery</h1>
            <p class="header-subtitle">@Localization.Current.General.Discovery.FindRelaysAndAdd</p>
        </div>
    </div>
</div>

<!-- Discovery Controls -->
<div class="discovery-controls">
    <div class="control-buttons">
        <button class="btn-primary-custom @(isScanning ? "btn-loading" : "")" 
                @onclick="ToggleScanning" 
                disabled="@isScanning">
            <i class="fas @(isScanning ? "fa-spinner fa-spin" : "fa-play")"></i>
            @(isScanning ? @Localization.Current.General.Discovery.Scanning : @Localization.Current.General.Discovery.StartScan)
        </button>
        
        <button class="btn-secondary-custom" 
                @onclick="StopScanning" 
                disabled="@(!isScanning)">
            <i class="fas fa-stop"></i>
            @Localization.Current.General.Discovery.StopScan
        </button>
        
        <button class="btn-secondary-custom" 
                @onclick="ShowManualAddModal">
            <i class="fas fa-plus"></i>
            @Localization.Current.General.Discovery.ManualAdd
        </button>
    </div>
    
    <!-- Status Information -->
    <div class="discovery-status">
        <div class="status-badges">
            <span class="status-badge @(isScanning ? "scanning" : "stopped")">
                <span class="status-dot"></span>
                @(isScanning ? @Localization.Current.General.Discovery.Scanning: @Localization.Current.General.Discovery.Stopped)
            </span>
            <span class="devices-count-badge">
                <i class="fas fa-microchip"></i>
                @(string.Format( Localization.Current.General.Discovery.FoundDevices, discoveredDevices.Count))
            </span>
        </div>
        
        @if (isScanning)
        {
            <div class="scan-progress">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <p class="scan-text">@Localization.Current.General.Discovery.SearchingForDeviceOnNetwork.</p>
            </div>
        }
    </div>
</div>

<!-- Discovered Devices List -->
<div class="devices-section">
    @if (discoveredDevices.Any())
    {
        <div class="devices-grid">
            @foreach (var device in discoveredDevices.OrderBy(d => d.DeviceId))
            {
                <div class="device-card @(addedDeviceIds.Contains(device.DeviceId) ? "added" : "")">
                    <div class="device-header">
                        <div class="device-icon">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <div class="device-info">
                            <h3 class="device-name">@device.DeviceId</h3>
                            <p class="device-ip">@device.IpAddress</p>
                            @if (!string.IsNullOrEmpty(device.Version))
                            {
                                <p class="device-version">@Localization.Current.General.Discovery.Firmware @device.Version</p>
                            }
                        </div>
                    </div>
                    
                    <div class="device-details">
                        <div class="detail-item">
                            <i class="fas fa-network-wired"></i>
                            <span>@Localization.Current.General.Discovery.Port @device.Port</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-clock"></i>
                            <span>@GetTimeAgo(device.LastSeen)</span>
                        </div>
                    </div>
                    
                    <div class="device-actions">
                        <a href="http://@device.IpAddress" target="_blank" 
                           class="btn-secondary-custom btn-small">
                            <i class="fas fa-external-link-alt"></i>
                            @Localization.Current.General.Discovery.WebUi
                        </a>
                        
                        @if (addedDeviceIds.Contains(device.DeviceId))
                        {
                            <button class="btn-success-custom btn-small" disabled>
                                <i class="fas fa-check"></i>
                                @Localization.Current.General.Discovery.Added
                            </button>
                        }
                        else
                        {
                            <button class="btn-primary-custom btn-small" 
                                    @onclick="() => AddDevice(device)"
                                    disabled="@(processingDeviceId == device.DeviceId)">
                                @if (processingDeviceId == device.DeviceId)
                                {
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>@Localization.Current.General.Discovery.Adding</span>
                                }
                                else
                                {
                                    <i class="fas fa-plus"></i>
                                    <span>@Localization.Current.General.Discovery.Add</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else if (isScanning)
    {
        <div class="scanning-state">
            <div class="scanning-icon">
                <i class="fas fa-search fa-2x"></i>
            </div>
            <h3>@Localization.Current.General.Discovery.ScanningForDevices</h3>
            <p>@Localization.Current.General.Discovery.SearchingDevicesCanTakeTime</p>
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-search"></i>
            </div>
            <h3>@Localization.Current.General.Discovery.NoDevicesFound</h3>
            <p>@Localization.Current.General.Discovery.SearchingDevicesCanTakeTime</p>
            <button class="btn-primary-custom" @onclick="ToggleScanning">
                <i class="fas fa-play"></i>
                @Localization.Current.General.Discovery.StartScan
            </button>
        </div>
    }
</div>

<!-- Bottom Safe Area -->
<div class="bottom-safe-area"></div>
<ManualAddDeviceModal 
    IsVisible="@showManualAddModal" 
    OnClose="@(() => showManualAddModal = false)"
    OnDeviceAdded="@OnDeviceAdded" />
@code {
    private List<TasmotaDiscoveredDevice> discoveredDevices = new();
    private HashSet<string> addedDeviceIds = new();
    private bool isScanning = false;
    private string? processingDeviceId = null;
    private bool showManualAddModal = false;

    private void ShowManualAddModal()
    {
        showManualAddModal = true;
        StateHasChanged();
    }

// OnDeviceAdded metodunu ekle:
    private async Task OnDeviceAdded(RelayBoard addedBoard)
    {
        showManualAddModal = false;
    
        // Discovery listesini güncelle
        var existingDevice = discoveredDevices.FirstOrDefault(d => d.IpAddress.ToString() == addedBoard.IpAddress);
        if (existingDevice != null)
        {
            addedDeviceIds.Add(existingDevice.DeviceId);
        }
    
        await JSRuntime.InvokeVoidAsync("showSuccessAlert", 
            @Localization.Current.General.Discovery.DeviceAddedTitle, 
            string.Format(@Localization.Current.General.Discovery.DeviceAddedWithRelayCount, addedBoard.Name, addedBoard.Relays.Count),
            @Localization.Current.General.Settings.Ok);
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync()
    {
        Localization.LanguageChanged += OnLanguageChanged;
        // Load already added devices to prevent duplicates
        var existingBoards = await relayDataService.GetAllBoardsAsync();
        addedDeviceIds = existingBoards
            .Select(b => ExtractDeviceIdFromBoard(b))
            .Where(id => !string.IsNullOrEmpty(id))
            .ToHashSet()!;

        // Subscribe to mDNS events - KEEP IT SIMPLE!
        mdnsService.DeviceDiscovered += OnDeviceDiscovered;
        mdnsService.DeviceLost += OnDeviceLost;
        mdnsService.LogMessage += OnLogMessage;

        // Load existing discovered devices
        discoveredDevices = mdnsService.DiscoveredDevices.ToList();
    }

    private void OnLanguageChanged(object sender, LanguageChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged); // Update UI
    }
    
    private string ExtractDeviceIdFromBoard(RelayBoard board)
    {
        // Simple extraction - you might need to adjust this logic
        return board.Name.Replace(" ", "").ToLower();
    }

    private async void OnDeviceDiscovered(TasmotaDiscoveredDevice device)
    {
        // Keep it simple - just update the list, NO TasmotaClient calls here!
        discoveredDevices = mdnsService.DiscoveredDevices.ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnDeviceLost(TasmotaDiscoveredDevice device)
    {
        discoveredDevices = mdnsService.DiscoveredDevices.ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnLogMessage(string message)
    {
        Console.WriteLine($"mDNS: {message}");
    }

    private async Task ToggleScanning()
    {
        if (isScanning) return;

        try
        {
            isScanning = true;
            StateHasChanged();

            await mdnsService.StartDiscoveryAsync();
            
            // Auto-stop after 30 seconds
            _ = Task.Run(async () =>
            {
                await Task.Delay(30000);
                if (isScanning)
                {
                    await InvokeAsync(async () =>
                    {
                        await StopScanning();
                    });
                }
            });
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showErrorAlert", 
                @Localization.Current.General.Settings.ScanError, 
                ex.Message,
                @Localization.Current.General.Settings.Ok);
            isScanning = false;
            StateHasChanged();
        }
    }

    private async Task StopScanning()
    {
        if (!isScanning) return;

        mdnsService.StopDiscovery();
        isScanning = false;
        StateHasChanged();
    }

   private async Task AddDevice(TasmotaDiscoveredDevice device)
{
   if (addedDeviceIds.Contains(device.DeviceId) || processingDeviceId == device.DeviceId)
       return;

   try
   {
       processingDeviceId = device.DeviceId;
       StateHasChanged();

       // TasmotaClient ile cihaz bilgilerini al
       tasmotaClient.SetIp(device.IpAddress.ToString());
       
       var status = await tasmotaClient.GetStatusAsync();
       if (status == null)
       {
           await JSRuntime.InvokeVoidAsync("showErrorAlert", 
               @Localization.Current.General.Discovery.ConnectionError, 
               string.Format(@Localization.Current.General.Discovery.ConnectionErrorToDeviceMessage,device.DeviceId),
               @Localization.Current.General.Settings.Ok);
           return;
       }

       string hostname = status.StatusNET?.Hostname ?? "";
       string macAddress = status.StatusNET?.Mac ?? "";
       string actualIp = status.StatusNET?.IPAddress ?? device.IpAddress.ToString();

       // ÖNCE mevcut cihaz varsa güncelle (Name ve Relays'e dokunma)
       var existingBoard = await relayDataService.FindAndUpdateByHostnameOrMacAsync(
           hostname, macAddress, actualIp);

       if (existingBoard != null)
       {
           addedDeviceIds.Add(device.DeviceId);
           await JSRuntime.InvokeVoidAsync("showSuccessAlert", 
               @Localization.Current.General.Discovery.DeviceUpdated, 
               string.Format(@Localization.Current.General.Discovery.DeviceUpdatedWithIp,existingBoard.Name,actualIp),
               @Localization.Current.General.Settings.Ok); 
           return;
       }

       // YENİ CİHAZ EKLEME
       var relayCount = await tasmotaClient.GetRelayCountAsync();
       if (relayCount == null || relayCount == 0)
       {
           relayCount = 4; // Default fallback
           await JSRuntime.InvokeVoidAsync("showInfoAlert", 
               @Localization.Current.General.Discovery.Information, 
               string.Format(@Localization.Current.General.Discovery.RelayCountNotDetectedAddingDefaultCount,relayCount),
               @Localization.Current.General.Settings.Ok);
       }

       string friendlyName = GetFriendlyDeviceName(status) ?? device.DeviceId;

       // Yeni board oluştur
       var newBoard = new RelayBoard
       {
           Name = friendlyName,
           IpAddress = actualIp,
           Hostname = hostname,
           MacAddress = macAddress,
           IsOnline = true,
           LastSeen = DateTime.Now
       };

       // Röleleri ekle - gerçek durumları ile
       for (int i = 1; i <= relayCount; i++)
       {
           bool? relayState = null;
           try
           {
               relayState = await tasmotaClient.GetRelayStateAsync(i);
           }
           catch
           {
               // Tek tek röle hatalarını yoksay
           }

           var relay = new RelayItem(i)
           {
               Name = string.Format(@Localization.Current.General.Discovery.Relay, i),
               IsOn = relayState ?? false,
               LastToggled = DateTime.Now
           };

           newBoard.Relays.Add(relay);
       }

       // Servise kaydet
       var addedBoard = await relayDataService.AddBoardAsync(newBoard);
       addedDeviceIds.Add(device.DeviceId);

       await JSRuntime.InvokeVoidAsync("showSuccessAlert", 
           Localization.Current.General.Discovery.DeviceAddedTitle, 
           string.Format(@Localization.Current.General.Discovery.DeviceAddedWithRelayCount,friendlyName,relayCount),
           @Localization.Current.General.Settings.Ok);
       
   }
   catch (Exception ex)
   {
       await JSRuntime.InvokeVoidAsync("showErrorAlert", 
           Localization.Current.General.Discovery.AddErrorTitle, 
           @Localization.Current.General.Discovery.ErrorWhileAddingDevice,
           @Localization.Current.General.Settings.Ok);
   }
   finally
   {
       processingDeviceId = null;
       StateHasChanged();
   }
}
    private string? GetFriendlyDeviceName(TasmotaSharp.Models.TasmotaStatus status)
    {
        // Try different sources for friendly name
        if (!string.IsNullOrEmpty(status.Status?.DeviceName))
            return status.Status.DeviceName;
            
        if (status.Status?.FriendlyName?.Length > 0 && !string.IsNullOrEmpty(status.Status.FriendlyName[0]))
            return status.Status.FriendlyName[0];
            
        if (!string.IsNullOrEmpty(status.StatusSTS?.Hostname))
            return status.StatusSTS.Hostname;
            
        if (!string.IsNullOrEmpty(status.StatusNET?.Hostname))
            return status.StatusNET.Hostname;

        return null;
    }

    
    private async Task ShowManualAddModalz()
    {
        var boardName = await JSRuntime.InvokeAsync<string>("prompt", Localization.Current.General.Discovery.DeviceName);
        if (string.IsNullOrWhiteSpace(boardName)) return;

        var boardIp = await JSRuntime.InvokeAsync<string>("prompt", @Localization.Current.General.Discovery.DeviceIp);
        if (string.IsNullOrWhiteSpace(boardIp)) return;

        try
        {
            processingDeviceId = "manual";
            StateHasChanged();

            tasmotaClient.SetIp(boardIp);
            var status = await tasmotaClient.GetStatusAsync();
            
            if (status == null)
            {
                await JSRuntime.InvokeVoidAsync("showErrorAlert", 
                    @Localization.Current.General.Discovery.ConnectionError, 
                    @Localization.Current.General.Discovery.ConnectionErrorToDeviceMessage);
                return;
            }

            var relayCount = await tasmotaClient.GetRelayCountAsync() ?? 4;
            
            var newBoard = new RelayBoard
            {
                Name = boardName,
                IpAddress = status.StatusNET?.IPAddress ?? boardIp,
                IsOnline = true,
                LastSeen = DateTime.Now
            };

            for (int i = 1; i <= relayCount; i++)
            {
                bool? relayState = null;
                try
                {
                    relayState = await tasmotaClient.GetRelayStateAsync(i);
                }
                catch { }

                newBoard.Relays.Add(new RelayItem(i)
                {
                    Name = $"{@Localization.Current.General.Discovery.Relay} {i}",
                    IsOn = relayState ?? false
                });
            }

            await relayDataService.AddBoardAsync(newBoard);
            
            await JSRuntime.InvokeVoidAsync("showSuccessAlert", 
                @Localization.Current.General.Discovery.DeviceAddedTitle, 
                string.Format(@Localization.Current.General.Discovery.DeviceAddedWithRelayCount,boardName,relayCount));
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showErrorAlert", 
                @Localization.Current.General.Discovery.AddErrorTitle, 
                @Localization.Current.General.Discovery.ErrorWhileAddingDevice);
        }
        finally
        {
            processingDeviceId = null;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        navigation.NavigateTo("/");
    }

    private string GetTimeAgo(DateTime lastSeen)
    {
        var timeSpan = DateTime.Now - lastSeen;
        
        if (timeSpan.TotalMinutes < 1)
            return Localization.Current.General.Discovery.JustNow;
        if (timeSpan.TotalMinutes < 60)
            return string.Format(@Localization.Current.General.Discovery.MinutesAgo, (int)timeSpan.TotalMinutes);
        if (timeSpan.TotalHours < 24)
            return string.Format(@Localization.Current.General.Discovery.HoursAgo, (int)timeSpan.TotalHours);
        
        return lastSeen.ToString(@Localization.Current.General.Discovery.TimeFormat);
    }

    public void Dispose()
    {
        Localization.LanguageChanged -= OnLanguageChanged;
        mdnsService.DeviceDiscovered -= OnDeviceDiscovered;
        mdnsService.DeviceLost -= OnDeviceLost;
        mdnsService.LogMessage -= OnLogMessage;
        
        if (isScanning)
        {
            mdnsService.StopDiscovery();
        }
    }
}